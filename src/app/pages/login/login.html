<div class="wyrm-auth-page d-flex flex-column">
  <app-nav-bar></app-nav-bar>

  <div class="flex-grow-1 row g-0 wyrm-auth-backdrop">
    <div class="col-12 d-flex align-items-center justify-content-center p-4 p-xl-5">
      
      <div class="wyrm-auth-card card border-0 rounded-4 p-4 p-md-5">
        <div class="row g-4 align-items-center">
          
          <div class="col-12 col-lg-7 auth-form-panel mx-auto">
            <div class="d-flex align-items-center gap-2 mb-4">
              <span class="golden-eyebrow"><i class="fa-solid fa-key me-2"></i> The Gateway</span>
            </div>

            @if (step() === 'credentials') {
              <h1 class="wyrm-auth-title mb-2">Welcome Back.</h1>
              <p class="wyrm-auth-subtitle mb-4">Present your credentials to enter the WyrmHole.</p>

              <form [formGroup]="credentialsForm" (ngSubmit)="submitCredentials()" novalidate>
                
                <div class="mb-3 position-relative">
                  <input id="email" type="email" formControlName="email" class="form-control wyrm-auth-input"
                    [class.is-invalid]="emailCtrl.invalid && emailCtrl.touched" placeholder="Email Address" autocomplete="email" />
                  <div class="invalid-feedback">
                    @if (emailCtrl.hasError('required')) { Email is required. } 
                    @else if (emailCtrl.hasError('email')) { Please enter a valid email address. }
                  </div>
                </div>

                <div class="mb-4 position-relative">
                  <input id="password" type="password" formControlName="password" class="form-control wyrm-auth-input"
                    [class.is-invalid]="passwordCtrl.invalid && passwordCtrl.touched" placeholder="Password" autocomplete="current-password" />
                  <div class="invalid-feedback">
                    @if (passwordCtrl.hasError('required')) { Password is required. } 
                    @else if (passwordCtrl.hasError('minlength')) { Password must be at least 6 characters long. }
                  </div>
                </div>

                @if (errorMessage()) {
                  <div class="alert wyrm-alert py-2 small mb-3" role="alert"><i class="fa-solid fa-triangle-exclamation me-2"></i>{{ errorMessage() }}</div>
                }

                <button type="submit" class="btn wyrm-auth-btn w-100 mt-2" [disabled]="isLoading()">
                  @if (isLoading()) {
                    <i class="fa-solid fa-spinner fa-spin me-2"></i> Opening portal…
                  } @else {
                    <i class="fa-solid fa-door-open me-2"></i> Enter
                  }
                </button>
              </form>

              <p class="text-center small wyrm-auth-footer mt-4 mb-0">
                Awaiting an invitation? <a routerLink="/register" class="wyrm-auth-link">Forge an account</a>
              </p>
            }

            @if (step() === 'otp') {
              <h1 class="wyrm-auth-title mb-2">Seal of Authenticity</h1>
              <p class="wyrm-auth-subtitle mb-4">
                We sent a 6-digit runic code to <strong>{{ email() }}</strong>
              </p>

              <form [formGroup]="otpForm" (ngSubmit)="submitOtp()" novalidate>
                <div class="mb-4">
                  <label for="otp" class="form-label wyrm-label fw-semibold">One-time password</label>
                  <input id="otp" type="text" inputmode="numeric" formControlName="otp" 
                    class="form-control wyrm-auth-input text-center otp-input"
                    [class.is-invalid]="otpCtrl.invalid && otpCtrl.touched" placeholder="• • • • • •" maxlength="6" autocomplete="one-time-code" />
                  <div class="invalid-feedback">
                    @if (otpCtrl.hasError('required')) { OTP is required. } 
                    @else if (otpCtrl.hasError('pattern')) { OTP must be exactly 6 characters. }
                  </div>
                </div>

                @if (errorMessage()) {
                  <div class="alert wyrm-alert py-2 small mb-3" role="alert"><i class="fa-solid fa-triangle-exclamation me-2"></i>{{ errorMessage() }}</div>
                }

                <button type="submit" class="btn wyrm-auth-btn w-100" [disabled]="isLoading()">
                  @if (isLoading()) {
                    <i class="fa-solid fa-spinner fa-spin me-2"></i> Verifying seal…
                  } @else {
                    Verify &amp; Enter
                  }
                </button>
              </form>

              <button type="button" class="btn btn-link p-0 wyrm-back-btn small mt-4" (click)="goBack()">
                <i class="fa fa-arrow-left me-1"></i> Return to threshold
              </button>
            }
          </div>

          <div class="col-lg-5 d-none d-lg-flex justify-content-center align-items-center">
            <div class="wyrm-image-container">
              <img src="sign.png" alt="WyrmHole Gateway" class="wyrm-auth-image" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>