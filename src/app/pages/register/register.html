<div class="wyrm-auth-page d-flex flex-column">
  <app-nav-bar></app-nav-bar>

  <div class="flex-grow-1 row g-0 wyrm-auth-backdrop">
    <div class="col-12 d-flex align-items-center justify-content-center p-4 p-xl-5">
      
      <div class="wyrm-auth-card card border-0 rounded-4 p-4 p-md-5">
        <div class="row g-4 align-items-center">
          
          <div class="col-12 col-lg-7 auth-form-panel mx-auto">
            <div class="d-flex align-items-center gap-2 mb-4">
              <span class="golden-eyebrow"><i class="fa-solid fa-scroll me-2"></i> The Ledger</span>
            </div>

            @if (step() === 'details') {
              <h1 class="wyrm-auth-title mb-2">Begin Your Journey.</h1>
              <p class="wyrm-auth-subtitle mb-4">Inscribe your details to access the archives.</p>

              <form [formGroup]="registerForm" (ngSubmit)="submitDetails()" novalidate>
                
                <div class="row g-3 mb-3">
                  <div class="col-6">
                    <input id="firstName" type="text" formControlName="firstName" class="form-control wyrm-auth-input"
                      [class.is-invalid]="firstNameCtrl.invalid && firstNameCtrl.touched" placeholder="First Name" />
                    <div class="invalid-feedback">
                      @if (firstNameCtrl.hasError('required')) { Required. } 
                      @else if (firstNameCtrl.hasError('minlength')) { Min 2 chars. }
                    </div>
                  </div>
                  <div class="col-6">
                    <input id="lastName" type="text" formControlName="lastName" class="form-control wyrm-auth-input"
                      [class.is-invalid]="lastNameCtrl.invalid && lastNameCtrl.touched" placeholder="Last Name" />
                    <div class="invalid-feedback">
                      @if (lastNameCtrl.hasError('required')) { Required. } 
                      @else if (lastNameCtrl.hasError('minlength')) { Min 2 chars. }
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <input id="email" type="email" formControlName="email" class="form-control wyrm-auth-input"
                    [class.is-invalid]="emailCtrl.invalid && emailCtrl.touched" placeholder="Email Address" />
                  <div class="invalid-feedback">
                    @if (emailCtrl.hasError('required')) { Email is required. } 
                    @else if (emailCtrl.hasError('email')) { Invalid email. }
                  </div>
                </div>

                <div class="row g-3 mb-3">
                  <div class="col-7">
                    <input id="dob" type="date" formControlName="dob" class="form-control wyrm-auth-input"
                      [class.is-invalid]="dobCtrl.invalid && dobCtrl.touched" [max]="maxDob" />
                    <div class="invalid-feedback">
                      @if (dobCtrl.hasError('required')) { Date is required. } 
                      @else if (dobCtrl.hasError('futureDate')) { Cannot be in the future. }
                    </div>
                  </div>
                  <div class="col-5 d-flex align-items-center">
                    <small class="wyrm-auth-subtitle">Date of Birth</small>
                  </div>
                </div>

                <div class="row g-3 mb-4">
                  <div class="col-6">
                    <input id="password" type="password" formControlName="password" class="form-control wyrm-auth-input"
                      [class.is-invalid]="passwordCtrl.invalid && passwordCtrl.touched" placeholder="Password" />
                    <div class="invalid-feedback">
                      @if (passwordCtrl.hasError('required')) { Required. } 
                      @else if (passwordCtrl.hasError('minlength')) { Min 8 chars. }
                    </div>
                  </div>
                  <div class="col-6">
                    <input id="confirmPassword" type="password" formControlName="confirmPassword" class="form-control wyrm-auth-input"
                      [class.is-invalid]="(confirmPasswordCtrl.invalid && confirmPasswordCtrl.touched) || passwordMismatch" placeholder="Confirm" />
                    <div class="invalid-feedback">
                      @if (confirmPasswordCtrl.hasError('required') && confirmPasswordCtrl.touched) { Please confirm. } 
                      @else if (passwordMismatch) { Passwords mismatch. }
                    </div>
                  </div>
                </div>

                @if (errorMessage()) {
                  <div class="alert wyrm-alert py-2 small mb-3" role="alert"><i class="fa-solid fa-triangle-exclamation me-2"></i>{{ errorMessage() }}</div>
                }

                <button type="submit" class="btn wyrm-auth-btn w-100 mt-2" [disabled]="isLoading()">
                  @if (isLoading()) {
                    <i class="fa-solid fa-spinner fa-spin me-2"></i> Inscribing…
                  } @else {
                    <i class="fa-solid fa-feather-pointed me-2"></i> Register
                  }
                </button>
              </form>

              <p class="text-center small wyrm-auth-footer mt-4 mb-0">
                Already hold a key? <a routerLink="/login" class="wyrm-auth-link">Enter here</a>
              </p>
            }

            @if (step() === 'otp') {
              <h1 class="wyrm-auth-title mb-2">Seal of Authenticity</h1>
              <p class="wyrm-auth-subtitle mb-4">We sent a 6-digit runic code to <strong>{{ email() }}</strong></p>

              <form [formGroup]="otpForm" (ngSubmit)="submitOtp()" novalidate>
                <div class="mb-4">
                  <label for="otp" class="form-label wyrm-label fw-semibold">One-time password</label>
                  <input id="otp" type="text" inputmode="numeric" formControlName="otp" class="form-control wyrm-auth-input text-center otp-input"
                    [class.is-invalid]="otpCtrl.invalid && otpCtrl.touched" placeholder="• • • • • •" maxlength="6" />
                </div>
                @if (errorMessage()) { <div class="alert wyrm-alert py-2 small mb-3">{{ errorMessage() }}</div> }
                <button type="submit" class="btn wyrm-auth-btn w-100" [disabled]="isLoading()">
                  @if (isLoading()) { <i class="fa-solid fa-spinner fa-spin me-2"></i> Verifying… } @else { Activate Account }
                </button>
              </form>
              <button type="button" class="btn btn-link p-0 wyrm-back-btn small mt-4" (click)="goBack()">
                <i class="fa fa-arrow-left me-1"></i> Return to registration
              </button>
            }
          </div>

          <div class="col-lg-5 d-none d-lg-flex justify-content-center align-items-center">
            <div class="wyrm-image-container">
              <img src="sign.png" alt="WyrmHole Registry" class="wyrm-auth-image" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>